<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>DiBS Web API</title>
    <script src="https://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
	<link rel="stylesheet" type="text/css" href="dibs.css"></link>
    <script type="text/javascript">
        $(document).ready(function () {
			var date = new Date().toISOString().slice(0,10);
			$(".title").append("Tap an open spot to book this room on " + moment(date).format('MMMM Do'));
			
			var objectDatas = [];
			
			//Loops the getData function over each room
			for(var room = 48; room <= 53; room++){
				getData(room);
			}
			
			/**
			*Uses JQuery magic to create the 3-level array objectDatas, which consists of [room number - 48][block of time reserved (0 - ?)][start time (0) or end time(1)].
			**/
			function getData(room){
				$.getJSON("https://chapelhill.evanced.info/dibsAPI/reservations/" + date + "/" + room,
				//Full disclosure here: I have no idea when this function (processData) actually runs. If anyone has to make serious modifications to this code,
				//I apologize-- it might be worth just rewriting the whole thing.
				//I especially apologize if it's future me who has to rewrite the whole thing. Good luck.
				function processData(jsonData) {
					var roomData = [];
					$.each(jsonData, function (object, objectData){
						roomData.push(new Array(objectData.StartTime, objectData.EndTime));
					});
					objectDatas[room - 48] = roomData;
					
					if(objectDatas.length == 6) mainLoop();
				});
			}
			
			/**
			*Fills the HTML table with the data from the objectDatas array.
			*Runs at the mercy of the arcane getData(). May return errors, but work fine anyway.
			*Don't say I didn't warn you.
			**/
			function mainLoop(){
			
				for(var t = openHours()[0]; t < openHours()[1]; t += .5){
					if(!isPast(t)){
						var items = [];
						//fills the "Start Time" and "End Time" columns
						items.push("<tr>");
						items.push("<td>" + formatTime(timeStr(t)) + " -" + formatTime(timeStr(t + .5)) + "</td>");
						//checks to see whether a room is booked for any time period;
						for(var n = 0; n <= 5; n++){
							items[3 + n] = ("<td>" + "<a href=http://chapelhill.evanced.info/dibs/?room=" + (48 + n) + ">Open</a></td>");
							for(var i = 0; i < objectDatas[n].length; i++){
								for(var k = .5; k <= duration(objectDatas[n][i][0], objectDatas[n][i][1]); k += .5){
									if(objectDatas[n][i][0] == timeStr(t) || objectDatas[n][i][1] == timeStr(t+k)){
										items[3 + n] = ("<td>Booked</td>");
									}
								}
							}
						}
						//appends data to the table
						$("<tbody/>", {
						html: items.join("")
						}).appendTo("table");
					}
				}
				
				setColors();
				
			}
			
			/**
			*Converts the variable used to store (t)ime in the main loop into the time in AM/PM format
			**/
			function formatTime(t){
				t = t.substr(11);
				if(t.substr(0, 2) > 11){
					t += " pm"
				}else{
					t += " am"
				}if(t.substr(0, 2) > 12){
					t = " " + (t.substr(0, 2) - 12) + t.substr(2);
				}else if(t.substr(0, 2) == 0){
					t = "12" + t.substr(2);
				}
				return t.substr(0, 5) + t.substr(8);
			}
			
			/**
			*Converts the variable used to store (t)ime in the main loop into the format used by XML files
			**/
			function timeStr(t){
					
				var timeStr = date + "T";
				if(t < 10) timeStr += "0";
				timeStr += t + ":00:00";
				if(t % 1 != 0) timeStr = timeStr.substr(0, 13) + ":30" + timeStr.substr(18);
				
				return timeStr;
					
			}
			
			/**
			*Returns the amount of time (in hours) between a (s)tart time and an (e)nd time
			**/
			function duration(s, e){
				var output = parseInt(e.substr(11, 13)) - parseInt(s.substr(11, 13));
				if(s.substr(14, 16) == "30") output -= .5;
				if(e.substr(14, 16) == "30") output += .5;
				return output;
			}
			
			/**
			*Returns whether a given time is in the past
			**/
			function isPast(t){
				t += .5;
				var time = new Date();
				if(time.getHours() > parseInt(timeStr(t).substr(11, 13)) || (time.getHours() == parseInt(timeStr(t).substr(11, 13)) && time.getMinutes() > parseInt(timeStr(t).substr(14, 16)))) return true;
				else return false;
			}
			
			/**
			*Sets the background colors of all cells with "Booked" in them to gray, "Open" to green, and headers to white.
			**/
			function setColors(){
				var allTableCells = document.getElementsByTagName("td");

				for(var i = 0, max = allTableCells.length; i < max; i++) {
					var node = allTableCells[i];

					var currentText = node.childNodes[0].nodeValue; 

					if(currentText === "Booked"){
						node.style.backgroundColor = "#d6d6d6";
						node.style.color = "#ffffff";
					}else if(currentText === null){
						node.style.backgroundColor = "#79bd90";
					}else{
						node.style.backgroundColor = "#ffffff";
						node.style.color = "#007ebd";
					}
				}
				
				var allHeaders = document.getElementsByTagName("th");
				
				for(var i = 0, max = allHeaders.length; i < max; i++) {
					allHeaders[i].style.backgroundColor = "#1975bc";
					allHeaders[i].style.color = "#ffffff";
				}
				
				var elements = document.getElementsByTagName('a');

				for (var i = 0; i < elements.length; i++) {
					elements[i].style.color = "ffffff";
				}
				
			}
			
			/**
			*Returns a two-integer array of the library's open hours depending on the day of the week: 10 AM - 6 PM on weekends,
			*9 AM - 6 PM on Fridays, and 9 AM - 8 PM otherwise.
			**/
			function openHours(){
				var d = new Date();
				if(d.getDay() == 0 || d.getDay() == 6) return [10, 18];
				if(d.getDay() == 5) return [9, 18];
				else return [9, 20];
			}
			
		});
			
    </script>

</head>
<body>
<h2 class="title"></h2>
    <table class="table">
      <thead>
        <tr>
          <th>Time</th>
		  <th>Room 1</th>
		  <th>Room 2</th>
		  <th>Room 3</th>
		  <th>Room 4</th>
		  <th>Room 5</th>
		  <th>Room 6</th>
        </tr>
      </thead>
    </table>
</body>
</html>
